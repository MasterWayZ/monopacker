---
{##
 # This file is processed into a YAML using Jinja2 by `monopacker/template_packer.py`,
 # then converted to a JSON file and passed to packer.
 #
 # Variables:
 #  - `builders` -- all builders
 #  - `linux_builders` -- names of builders with platform = linux
 #  - `windows_builders` -- names of builders with platform = windows
 #
 # Each builder has the form
 # {
 #    "template": .., // The Jinja2 template under `template/builders/` used to
 #                    // generate the Packer builder definition
 #    "vars": ..,     // The variables specific to this builder (available as
 #                    // `builder.vars.<varname>` inside the builder template
 #    "scripts": ..,  // Scripts derived from the `script_directories` builder config
 #    "platform": .., // The platform from the builder config
 # }
 #
 # The "name" var is always set to the name of the builder.
 #}

builders:
{% for builder in builders %}
  {% filter indent(width=2, first=False) %}
    {%- include (builder.template + ".jinja2") %}
  {%- endfilter %}
{%- endfor %}

provisioners:
  ### Linux only pre-script steps
  # certain monopacker scripts require contents of ./files
  # to be on the filesystem before running
  # wait for cloud-init before running scripts
  {%- if linux_builders %}
  # created by make tar
  - type: file
    source: ./files.tar
    destination: /tmp/
  # untar at /
  - type: shell
    # files.tar is two levels deep (/tmp/files)
    inline:
      - sudo tar xvf /tmp/files.tar -C / --strip-components=2
      - rm /tmp/files.tar
  # created by pack_secrets.py, make tar
  - type: file
    source: ./secrets.tar
    destination: /tmp/
  # untar at /
  - type: shell
    inline:
      - sudo mkdir -p /etc/taskcluster/secrets
      - sudo tar xvf /tmp/secrets.tar -C /
      - sudo chown root:root -R /etc/taskcluster
      - sudo chmod 0400 -R /etc/taskcluster/secrets
      - rm /tmp/secrets.tar
    only: {{linux_builders}}
  - type: shell
    inline:
      - /usr/bin/cloud-init status --wait
    only: {{linux_builders}}
  {%- endif %}

  ### Windows only pre-script steps
  # TODO
  # open question: where should we put them?
  {%- if windows_builders %}
  {%- endif %}

  {%- for builder in builders %}
    {%- if linux_builders %}
  - type: shell
    scripts: {{builder.scripts}}
    environment_vars: {{builder.vars.env_vars}}
    execute_command: {{builder.vars.execute_command}}
    # we reboot the host to update the kernel
    expect_disconnect: true
    # metal is slow to reboot
    start_retry_timeout: {{builder.vars.ssh_timeout}}
    only: [{{builder.vars.name if builder.platform == 'linux'}}]
    {%- endif %}
    {%- if windows_builders %}
  - type: powershell
    scripts: {{builder.scripts}}
    only: [{{builder.vars.name if builder.platform == 'windows'}}]
    {%- endif %}
  {%- endfor %}

post-processors:
  - type: manifest
    output: packer-artifacts.json
    strip_path: true
